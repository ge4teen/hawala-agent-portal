{% extends "base_agent.html" %}
{% block content %}

<div class="container-fluid">
    <h2 class="fw-bold mb-4">Verify Transaction</h2>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-file-invoice-dollar me-2"></i>
                        Transaction Verification
                    </h5>
                </div>
                <div class="card-body p-4">
                    <!-- Transaction ID Header -->
                    <div class="alert alert-dark mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Transaction ID:</strong>
                                <span class="font-monospace ms-2">{{ tx.transaction_id }}</span>
                            </div>
                            <div>
                                <span class="badge bg-{% if tx.status == 'pending' %}warning{% elif tx.status == 'completed' %}success{% else %}secondary{% endif %} fs-6">
                                    {{ tx.status|title }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Amount Information -->
                    <div class="card mb-4 border-info">
                        <div class="card-header bg-info bg-opacity-10 border-info">
                            <h6 class="mb-0">
                                <i class="fas fa-money-bill-wave me-2"></i>
                                Amount Details
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="text-center p-3 bg-light rounded">
                                        <small class="text-muted d-block mb-1">TO BE RECEIVED</small>
                                        <h3 class="text-success fw-bold mb-0">
                                            ${{ "%.2f"|format(tx.amount_foreign) if tx.amount_foreign else "0.00" }}
                                        </h3>
                                        <small class="text-muted">USD Amount</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="text-center p-3 bg-light rounded">
                                        <small class="text-muted d-block mb-1">EQUIVALENT IN</small>
                                        <h4 class="text-primary fw-bold mb-0">
                                            ZAR {{ "%.2f"|format(tx.amount_local) if tx.amount_local else "0.00" }}
                                        </h4>
                                        <small class="text-muted">South African Rand</small>
                                    </div>
                                </div>
                            </div>

                            {% if tx.amount_local and tx.amount_foreign and tx.amount_foreign > 0 %}
                            <div class="mt-3 text-center">
                                <small class="text-muted">
                                    <i class="fas fa-exchange-alt me-1"></i>
                                    Exchange Rate: <strong>1 USD = {{ (tx.amount_local / tx.amount_foreign)|round(4) }} ZAR</strong>
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Payment Information -->
                    <div class="card mb-4 border-warning">
                        <div class="card-header bg-warning bg-opacity-10 border-warning">
                            <h6 class="mb-0">
                                <i class="fas fa-credit-card me-2"></i>
                                Payment Information
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Payment Method:</strong>
                                    <div class="mt-2">
                                        {% if tx.payment_method == 'cash' %}
                                            <span class="badge bg-primary fs-6 p-2">
                                                <i class="fas fa-money-bill me-1"></i> Cash
                                            </span>
                                        {% elif tx.payment_method == 'franc_cash' %}
                                            <span class="badge bg-warning fs-6 p-2">
                                                <i class="fas fa-coins me-1"></i> Franc (Cash)
                                            </span>
                                        {% elif tx.payment_method == 'franc_electronic' %}
                                            <span class="badge bg-success fs-6 p-2">
                                                <i class="fas fa-wallet me-1"></i> Franc (Electronic)
                                            </span>
                                        {% elif tx.payment_method == 'bank_transfer' %}
                                            <span class="badge bg-info fs-6 p-2">
                                                <i class="fas fa-university me-1"></i> Bank Transfer
                                            </span>
                                        {% elif tx.payment_method == 'mobile_money' %}
                                            <span class="badge bg-purple fs-6 p-2">
                                                <i class="fas fa-mobile-alt me-1"></i> Mobile Money
                                            </span>
                                        {% elif tx.payment_method == 'other' %}
                                            <span class="badge bg-secondary fs-6 p-2">
                                                <i class="fas fa-ellipsis-h me-1"></i> Other
                                            </span>
                                        {% else %}
                                            <span class="badge bg-light text-dark fs-6 p-2">
                                                <i class="fas fa-question-circle me-1"></i> Not Specified
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <strong>Currency:</strong>
                                    <div class="mt-2">
                                        <span class="badge bg-dark fs-6 p-2">
                                            {{ tx.currency_code }}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            {% if tx.notes %}
                            <div class="mb-3">
                                <strong>Notes / Instructions:</strong>
                                <div class="alert alert-light mt-2">
                                    <i class="fas fa-sticky-note me-2 text-muted"></i>
                                    {{ tx.notes }}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Parties Information -->
                    <div class="card mb-4 border-success">
                        <div class="card-header bg-success bg-opacity-10 border-success">
                            <h6 class="mb-0">
                                <i class="fas fa-users me-2"></i>
                                Parties Involved
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="border-bottom pb-2">
                                        <i class="fas fa-paper-plane me-2 text-primary"></i>
                                        Sender
                                    </h6>
                                    <p class="mb-1"><strong>Name:</strong> {{ tx.sender_name }}</p>
                                    {% if tx.sender_phone %}
                                    <p class="mb-0">
                                        <strong>Phone:</strong>
                                        <a href="tel:{{ tx.sender_phone }}" class="text-decoration-none">
                                            <i class="fas fa-phone me-1"></i>{{ tx.sender_phone }}
                                        </a>
                                    </p>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <h6 class="border-bottom pb-2">
                                        <i class="fas fa-user-check me-2 text-success"></i>
                                        Receiver
                                    </h6>
                                    <p class="mb-1"><strong>Name:</strong> {{ tx.receiver_name }}</p>
                                    {% if tx.receiver_phone %}
                                    <p class="mb-0">
                                        <strong>Phone:</strong>
                                        <a href="tel:{{ tx.receiver_phone }}" class="text-decoration-none">
                                            <i class="fas fa-phone me-1"></i>{{ tx.receiver_phone }}
                                        </a>
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Action Panel -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                <div class="card-header bg-dark text-white py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-check me-2"></i>
                        Verification Actions
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Verification Warning -->
                    <div class="alert alert-warning border-warning mb-4">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="alert-heading">Verification Required</h6>
                                <p class="mb-0 small">
                                    Confirm that you have received <strong>${{ "%.2f"|format(tx.amount_foreign) if tx.amount_foreign else "0.00" }}</strong>
                                    and completed the transaction to the receiver.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method Reminder -->
                    <div class="alert alert-info border-info mb-4">
                        <h6 class="alert-heading">
                            <i class="fas fa-info-circle me-1"></i>
                            Payment Method:
                            <span class="text-uppercase">{{ tx.payment_method|replace('_', ' ')|title if tx.payment_method else 'Not Specified' }}</span>
                        </h6>
                        <p class="small mb-0">
                            {% if tx.payment_method == 'cash' %}
                                Ensure you have received physical cash payment.
                            {% elif tx.payment_method == 'franc_cash' %}
                                Verify Franc cash payment was received.
                            {% elif tx.payment_method == 'franc_electronic' %}
                                Confirm electronic wallet transfer was received.
                            {% elif tx.payment_method == 'bank_transfer' %}
                                Verify bank transfer confirmation.
                            {% elif tx.payment_method == 'mobile_money' %}
                                Check mobile money transaction confirmation.
                            {% else %}
                                Verify payment according to the specified method.
                            {% endif %}
                        </p>
                    </div>

                    <!-- Transaction Details Summary -->
                    <div class="card border-light mb-4">
                        <div class="card-body p-3">
                            <h6 class="card-title text-muted mb-3">
                                <i class="fas fa-list-ul me-1"></i>
                                Quick Summary
                            </h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between px-0">
                                    <span>Amount (USD):</span>
                                    <strong class="text-success">${{ "%.2f"|format(tx.amount_foreign) if tx.amount_foreign else "0.00" }}</strong>
                                </li>
                                <li class="list-group-item d-flex justify-content-between px-0">
                                    <span>Amount (ZAR):</span>
                                    <strong class="text-primary">ZAR {{ "%.2f"|format(tx.amount_local) if tx.amount_local else "0.00" }}</strong>
                                </li>
                                <li class="list-group-item d-flex justify-content-between px-0">
                                    <span>Payment Method:</span>
                                    <strong>{{ tx.payment_method|replace('_', ' ')|title if tx.payment_method else 'N/A' }}</strong>
                                </li>
                                <li class="list-group-item d-flex justify-content-between px-0">
                                    <span>Created:</span>
                                    <small>{{ tx.timestamp|format_date if tx.timestamp else 'N/A' }}</small>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <form method="POST" action="{{ url_for('agent.complete_transaction', txid=tx.transaction_id ) }}">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg py-3">
                                <i class="fas fa-check-circle me-2"></i>
                                CONFIRM & COMPLETE TRANSACTION
                            </button>

                            <a href="{{ url_for('agent.pending_transactions') }}" class="btn btn-outline-secondary py-3">
                                <i class="fas fa-arrow-left me-2"></i>
                                Back to Pending Transactions
                            </a>

                            <button type="button" class="btn btn-outline-info py-3" data-bs-toggle="modal" data-bs-target="#helpModal">
                                <i class="fas fa-question-circle me-2"></i>
                                Need Help?
                            </button>
                        </div>
                    </form>

                    <!-- Quick Contact -->
                    <div class="mt-4 pt-3 border-top">
                        <h6 class="text-muted mb-2">
                            <i class="fas fa-headset me-1"></i>
                            Need Assistance?
                        </h6>
                        <p class="small mb-0">
                            Contact admin if there are issues with this transaction.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-question-circle me-2"></i>
                    Verification Help
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Before completing this transaction:</h6>
                <ol class="mb-3">
                    <li>Verify you have received <strong>${{ "%.2f"|format(tx.amount_foreign) if tx.amount_foreign else "0.00" }}</strong></li>
                    <li>Confirm the payment method: <strong>{{ tx.payment_method|replace('_', ' ')|title if tx.payment_method else 'N/A' }}</strong></li>
                    <li>Check any special instructions in the notes section</li>
                    <li>Ensure receiver information is correct</li>
                </ol>

                <div class="alert alert-warning">
                    <h6 class="alert-heading">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Important
                    </h6>
                    <p class="small mb-0">
                        Once marked as completed, this transaction cannot be undone.
                        Make sure all details are correct before proceeding.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.font-monospace {
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
}
.bg-purple {
    background-color: #6f42c1 !important;
}
.bg-light-green {
    background-color: #d1e7dd !important;
}
.bg-light-yellow {
    background-color: #fff3cd !important;
}
.bg-light-blue {
    background-color: #cff4fc !important;
}
.sticky-top {
    position: sticky;
    z-index: 1020;
}
.card {
    border-radius: 12px;
    overflow: hidden;
}
.card-header {
    border-bottom: none;
}
.badge {
    border-radius: 8px;
}
.list-group-item {
    border: none;
    padding: 0.75rem 0;
}
.btn-lg {
    border-radius: 10px;
    font-weight: 600;
}
.alert {
    border-radius: 10px;
    border-left: 4px solid;
}
</style>

<script>
// Add confirmation before submitting
document.addEventListener('DOMContentLoaded', function() {
    const completeBtn = document.querySelector('button[type="submit"]');
    if (completeBtn) {
        completeBtn.addEventListener('click', function(e) {
            const amountUSD = '${{ "%.2f"|format(tx.amount_foreign) if tx.amount_foreign else "0.00" }}';
            const paymentMethod = '{{ tx.payment_method|replace("_", " ")|title if tx.payment_method else "Not Specified" }}';

            if (!confirm(`CONFIRM VERIFICATION:\n\n• Received: ${amountUSD}\n• Payment Method: ${paymentMethod}\n\nAre you sure you want to mark this transaction as completed?`)) {
                e.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}